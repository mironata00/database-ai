# Настройка синонимов колонок

## Как работает система определения колонок

Система автоматически определяет колонки в прайс-листах, используя **синонимы** - различные варианты названий одной и той же колонки.

### Пример работы

Если в прайсе есть колонки:
```
| Код товара | Наименование продукта | Цена, руб | Производитель |
|------------|----------------------|-----------|---------------|
| ART-123    | Гипсокартон Knauf   | 450.00    | Knauf         |
```

Система определит:
- "Код товара" → **SKU** (совпадает с синонимом "код товара")
- "Наименование продукта" → **NAME** (совпадает с синонимом "наименование")
- "Цена, руб" → **PRICE** (совпадает с синонимом "цена руб")
- "Производитель" → **BRAND** (совпадает с синонимом "производитель")

## Настройка в .env

### Базовые синонимы (уже настроены)

```bash
# Артикул/Код
PARSING_COLUMN_SKU_SYNONYMS=sku|артикул|код|article|арт|код товара|артикул товара|vendor code|item code|part number|партномер|каталожный номер

# Наименование
PARSING_COLUMN_NAME_SYNONYMS=name|наименование|название|товар|продукт|описание|product|item|description|номенклатура|материал

# Цена
PARSING_COLUMN_PRICE_SYNONYMS=price|цена|стоимость|прайс|cost|розница|опт|розничная цена|оптовая цена|price rub|цена руб

# Бренд
PARSING_COLUMN_BRAND_SYNONYMS=brand|бренд|производитель|марка|manufacturer|vendor|поставщик|завод

# Категория
PARSING_COLUMN_CATEGORY_SYNONYMS=category|категория|группа|раздел|тип|вид|class|group|подгруппа

# Единица измерения
PARSING_COLUMN_UNIT_SYNONYMS=unit|ед|единица|единица измерения|ед.изм|measure|uom

# Остаток
PARSING_COLUMN_STOCK_SYNONYMS=stock|остаток|наличие|количество|qty|available|в наличии|склад
```

### Как добавить свои варианты

#### Вариант 1: Через разделитель "|"

Добавьте новые варианты через вертикальную черту:

```bash
# Было:
PARSING_COLUMN_SKU_SYNONYMS=sku|артикул|код

# Стало (добавили "номер изделия"):
PARSING_COLUMN_SKU_SYNONYMS=sku|артикул|код|номер изделия
```

#### Вариант 2: Специфичные для вашего бизнеса термины

Если у вас специальные названия колонок:

```bash
# Добавляем внутренние термины компании
PARSING_COLUMN_SKU_SYNONYMS=sku|артикул|код|internal_code|внутренний номер|номер спецификации

# Добавляем отраслевые термины (например, для медицины)
PARSING_COLUMN_NAME_SYNONYMS=name|наименование|название|препарат|мнн|торговое наименование

# Для строительных материалов
PARSING_COLUMN_CATEGORY_SYNONYMS=category|категория|группа|вид материала|тип конструкции
```

## Примеры распространенных вариантов

### Артикул (SKU)
```
✓ sku, артикул, код
✓ article, арт., арт
✓ код товара, код изделия
✓ vendor code, item code
✓ part number, part#, p/n
✓ партномер, партнамбер
✓ каталожный номер
✓ №, номер
```

### Наименование (NAME)
```
✓ name, наименование, название
✓ товар, продукт, product
✓ описание, description
✓ item, item name
✓ номенклатура
✓ материал, изделие
✓ позиция
```

### Цена (PRICE)
```
✓ price, цена, стоимость
✓ прайс, cost
✓ розница, опт
✓ розничная цена, оптовая цена
✓ price rub, цена руб
✓ цена с ндс, цена без ндс
✓ базовая цена
```

## Дополнительные настройки

### Нечеткий поиск (Fuzzy Matching)

```bash
# Включить нечеткий поиск (допускает опечатки)
PARSING_COLUMN_FUZZY_MATCHING=true

# Минимальная уверенность совпадения (0.0 - 1.0)
PARSING_COLUMN_MIN_CONFIDENCE=0.7
```

**Пример работы нечеткого поиска:**
- "наимнование" → найдет "наименование" (опечатка)
- "цена рубл" → найдет "цена руб" (неполное слово)
- "артику" → найдет "артикул" (обрезанное)

### Подсказки по позиции

```bash
# Использовать эвристику позиции колонок
PARSING_COLUMN_USE_POSITION_HINTS=true
```

Эвристика:
- **SKU** обычно в первых колонках (0-20%)
- **NAME** обычно после SKU (10-40%)
- **PRICE** обычно в середине-конце (30-80%)
- **UNIT** обычно ближе к концу (40-90%)
- **STOCK** обычно в последних колонках (60-100%)

## Режимы детекции

```bash
# auto - автоматическое определение с синонимами
# manual - пользователь указывает маппинг вручную
# ai - использовать GPT-4o для определения (требует AI_ENABLED=true)
PARSING_COLUMN_DETECTION_MODE=auto
```

## Обязательные колонки

```bash
# Колонки, которые ОБЯЗАТЕЛЬНО должны быть найдены
PARSING_REQUIRED_COLUMNS=sku,name,price
```

Если хотя бы одна из обязательных колонок не найдена, парсинг будет отклонен с подробным отчетом.

## Примеры реальных прайсов

### Пример 1: Стандартный прайс
```
| Артикул | Наименование | Цена | Бренд |
```
✅ Определится автоматически

### Пример 2: Нестандартные названия
```
| Код изделия | Описание товара | Стоимость руб | Завод-изготовитель |
```
✅ Определится, если добавить синонимы:
```bash
PARSING_COLUMN_SKU_SYNONYMS=...|код изделия
PARSING_COLUMN_NAME_SYNONYMS=...|описание товара
PARSING_COLUMN_PRICE_SYNONYMS=...|стоимость руб
PARSING_COLUMN_BRAND_SYNONYMS=...|завод-изготовитель
```

### Пример 3: Английский прайс
```
| Item Code | Product Name | Price USD | Manufacturer |
```
✅ Определится автоматически (английские синонимы уже есть)

### Пример 4: Смешанный формат
```
| № | Артикул | Наименование товара | Цена с НДС | Производитель | Ед.изм. | Остаток |
```
✅ Определится полностью (все синонимы покрыты)

## Отладка

Если колонки не определяются:

1. **Проверьте логи**
   ```bash
   docker-compose logs api | grep "Detecting columns"
   ```

2. **Посмотрите отчет детекции**
   В логах будет:
   ```
   Column Detection Report:
   ==========================================
   ✓ sku          -> 'Артикул'
   ✓ name         -> 'Наименование'
   ✓ price        -> 'Цена'
   ✗ brand        -> NOT FOUND
   ✗ category     -> NOT FOUND
   ```

3. **Добавьте отсутствующие синонимы в .env**

4. **Перезапустите сервисы**
   ```bash
   docker-compose restart api celery_worker_parsing
   ```

## API для тестирования

Можно протестировать детекцию через API:

```bash
POST /api/admin/test-column-detection
Content-Type: multipart/form-data

{
  "file": <ваш_прайс.xlsx>
}

# Ответ:
{
  "detected_columns": {
    "sku": "Код товара",
    "name": "Наименование",
    "price": "Цена"
  },
  "columns_found": ["Код товара", "Наименование", "Цена", "Бренд"],
  "mapping_report": "...",
  "confidence": 0.95
}
```

## Советы по настройке

### 1. Начните с базовых синонимов
Используйте стандартный .env.example - он покрывает 90% случаев.

### 2. Добавляйте постепенно
При появлении нового формата прайса:
- Посмотрите названия колонок
- Добавьте их в соответствующие SYNONYMS
- Перезапустите сервис

### 3. Используйте нижний регистр
Все синонимы автоматически приводятся к нижнему регистру, но лучше сразу писать в lowercase.

### 4. Короткие варианты - в конце
Размещайте короткие синонимы (типа "код", "арт") в конце списка, чтобы приоритет был у полных названий.

```bash
# Правильно:
PARSING_COLUMN_SKU_SYNONYMS=артикул товара|код товара|артикул|код|арт

# Неправильно (короткие синонимы будут срабатывать на всё):
PARSING_COLUMN_SKU_SYNONYMS=арт|код|артикул|код товара
```

### 5. Регулярно обновляйте
Собирайте статистику по прайсам и добавляйте новые варианты в .env.

## Частые вопросы

**Q: Можно ли использовать пробелы в синонимах?**
A: Да! "код товара" с пробелом - это валидный синоним.

**Q: Учитывается ли регистр?**
A: Нет, все приводится к нижнему регистру автоматически.

**Q: Можно ли использовать спецсимволы?**
A: Лучше избегать. Система автоматически убирает большинство спецсимволов при нормализации.

**Q: Что делать если 2 колонки подходят под один синоним?**
A: Система выберет первую найденную с наивысшим score. Используйте более специфичные синонимы.

**Q: Можно ли отключить автоопределение?**
A: Да, установите `PARSING_COLUMN_DETECTION_MODE=manual` и укажите маппинг через API.

**Q: Сколько синонимов можно добавить?**
A: Технически неограниченно, но рекомендуется до 20-30 на тип колонки для производительности.
